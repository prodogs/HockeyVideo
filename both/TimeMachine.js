/// <reference path="../typescript-defs/all-definitions.d.ts"/>
console.log("Loading TimeMachine.ts ...");
//endregion
class TimeMachineClass {
    constructor() {
        this.objectCount = 0;
        this.checkPointPrefix = "Time Machine Checkpoint ";
        this.versionDate = Date();
        this.versionID = Random.id();
    }
    restore(id) {
        Meteor.call("loadTimeMachine", id);
    }
    getVersion() {
        return "Version ID = " + this.versionID + " Date = " + this.getDate().toLocaleDateString;
    }
    getDate() {
        return this.versionDate;
    }
    getVersionName() {
        return this.checkPointPrefix + this.getDate().toDateString() + " " + this.getDate().toTimeString();
    }
    Checkpoint() {
        Meteor.call("checkpointTimeMachine");
    }
    checkPointServer(checkPointPrefix) {
        /*
           if (checkPointPrefix) {
               this.checkPointPrefix = checkPointPrefix
           }
           AppLog.info("Time Machine SaveAll Called = " + this.getVersion());
           try {
               this.jsonArray = new Array<any>();
               for (var item in Factory.collectionArray) {
                   var objectSpec = (Factory.collectionArray[item]);
                   if (objectSpec.timeCapsule) {
                       this.pushCollection(objectSpec.classType);
                   }
               }
               var capsuleString:string = EJSON.stringify(VideoApp.EJSONcast(this.jsonArray));
               var timeMachineProxy:any = Factory.CreateProxyInstance(ClassType.TIME_MACHINE);
               this.versionDate = new Date();
               var checkPointObject:any = {
                   name: this.getVersionName(),
                   versionID       : this.versionID,
                   objectCount     : this.objectCount,
                   date: this.versionDate,
                   jsonArray: capsuleString
               };
               timeMachineProxy.addNewObject(checkPointObject);
           } catch (e) { AppLog.error("Error While Saving All in TimeMachine", e);}
           */
    }
    pushCollection(classType) {
        try {
            var objectProxy = Factory.CreateProxyInstance(classType);
            var records = objectProxy.getList(false);
            this.objectCount += records.length;
            // var stringy = EJSON.stringify(records);
            this.jsonArray.push({ classType: classType, records: records });
        }
        catch (e) {
            AppLog.error("Error Pushing Collection for ClassType = " + classType, e);
        }
    }
    restoreServer(id) {
        AppLog.info("TimeMachine RestoreAll Called with ID = " + id);
        this.checkPointServer("Checkpoint B4 restore ");
        this.CleanDB();
        // var timeMachineProxy = Factory.CreateProxyInstance(ClassType.TIME_MACHINE);
        AppLog.info("Time Machine Getting Capsule to restore");
        try {
            this.capsule = timeMachineProxy.getOne(id);
        }
        catch (e) {
            AppLog.error("Error Getting TimeMachine Capsule for id = " + id, e);
        }
        if (!this.capsule) {
            AppLog.error("Could Not Find TimeMachine Capsule for ID " + id);
            return;
        }
        this.capsuleArray = EJSON.parse(this.capsule.jsonArray);
        AppLog.info("Time Machine Loading Capsule Collections");
        for (var i = 0; i < this.capsuleArray.length; i++) {
            this.popCollection(this.capsuleArray[i]);
        }
    }
    popCollection(theRecord) {
        var objectProxy = Factory.CreateProxyInstance(theRecord.classType);
        AppLog.info("Time Machine Restoring Collection for " + theRecord.classType);
        var classType = theRecord.classType;
        if (!objectProxy) {
            AppLog.error("Could Not Find Collection for Class = " + classType);
            return;
        }
        for (var i = 0; i < theRecord.records.length; i++) {
            try {
                objectProxy.restoreObject(theRecord.records[i]);
            }
            catch (e) {
                AppLog.error("Time Machine Error Inserting Object", e, theRecord.records[i]);
            }
        }
    }
    CleanDB() {
        Meteor.call("cleanDB");
    }
    cleanDBServer() {
        AppLog.record("Cleaning Database From Server", new Error(), null);
        this.checkPointServer("CleanDB CheckPoint ");
        for (var item in Factory.collectionArray) {
            var objectSpec = Factory.collectionArray[item];
            if (objectSpec.timeCapsule) {
                var objectProxy = Factory.CreateProxyInstance(objectSpec.classType);
                objectProxy.removeAll();
            }
        }
    }
}
this.TimeMachineClass = TimeMachineClass;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGltZU1hY2hpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJUaW1lTWFjaGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSwrREFBK0Q7QUFJL0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBc0IxQyxXQUFXO0FBRVg7SUFVSTtRQUhPLGdCQUFXLEdBQVUsQ0FBQyxDQUFDO1FBQ3ZCLHFCQUFnQixHQUFVLDBCQUEwQixDQUFDO1FBR3hELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVNLE9BQU8sQ0FBQyxFQUFTO1FBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUNNLFVBQVU7UUFDYixNQUFNLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLEdBQUcsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQztJQUM3RixDQUFDO0lBQ00sT0FBTztRQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzVCLENBQUM7SUFDTSxjQUFjO1FBQ2pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLFlBQVksRUFBRSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDdkcsQ0FBQztJQUNNLFVBQVU7UUFDYixNQUFNLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7SUFDekMsQ0FBQztJQUNNLGdCQUFnQixDQUFDLGdCQUF3QjtRQUMvQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzthQXlCSztJQUNOLENBQUM7SUFDTSxjQUFjLENBQUMsU0FBbUI7UUFD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LENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxDQUFDLEVBQUUsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsQ0FBQztRQUNqRyxDQUFDO0lBQ0wsQ0FBQztJQUNNLE9BQU87UUFDVixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFDTSxhQUFhO1FBQ2hCLE1BQU0sQ0FBQyxNQUFNLENBQUMsK0JBQStCLEVBQUUsSUFBSSxLQUFLLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUM3QyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUN2QyxJQUFJLFVBQVUsR0FBRSxPQUFPLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNwRSxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDNUIsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0FBQ0wsQ0FBQztBQUFBLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBlc2NyaXB0LWRlZnMvYWxsLWRlZmluaXRpb25zLmQudHNcIi8+XG5cblxuXG5jb25zb2xlLmxvZyhcIkxvYWRpbmcgVGltZU1hY2hpbmUudHMgLi4uXCIpO1xuXG4vL3JlZ2lvbiBHbG9iYWwgVmFyaWFibGUgRGVjbGFyYXRpb25zXG5kZWNsYXJlIHZhciBUaW1lTWFjaGluZVN0b3JlOk1vbmdvLkNvbGxlY3Rpb248YW55PjtcbmRlY2xhcmUgdmFyIENhcGFiaWxpdHlTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT47XG5kZWNsYXJlIHZhciBEaW1lbnNpb25TdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cbmRlY2xhcmUgdmFyIFRhc2tTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cbmRlY2xhcmUgdmFyIFNjZW5hcmlvU3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XG5kZWNsYXJlIHZhciBQcm9kdWN0U3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XG5kZWNsYXJlIHZhciBHb2FsU3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XG5kZWNsYXJlIHZhciBNZXRyaWNTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cbmRlY2xhcmUgdmFyIE1hcDpNb25nby5Db2xsZWN0aW9uPGFueT5cbmRlY2xhcmUgdmFyIEFzc2V0U3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XG5kZWNsYXJlIHZhciBGb2xkZXJTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cbmRlY2xhcmUgdmFyIExpYnJhcnlTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cbmRlY2xhcmUgdmFyIEZlYXR1cmVTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cbmRlY2xhcmUgdmFyIEluaXRpYXRpdmVTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cbmRlY2xhcmUgdmFyIFRhc2tEZXBlbmRlbmN5U3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XG5kZWNsYXJlIHZhciBNZXRyaWNUeXBlU3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XG5kZWNsYXJlIHZhciBBc3NldENhdGVnb3J5U3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XG5kZWNsYXJlIHZhciBQcm9kdWN0Q2F0ZWdvcnlTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cbmRlY2xhcmUgdmFyIERpYWdyYW1TdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cbi8vZW5kcmVnaW9uXG5cbmNsYXNzIFRpbWVNYWNoaW5lQ2xhc3Mge1xuXG4gICAgcHVibGljIHZlcnNpb25JRDpzdHJpbmc7XG4gICAgcHVibGljIHZlcnNpb25EYXRlOmFueTtcbiAgICBwdWJsaWMganNvbkFycmF5IDogQXJyYXk8YW55PjtcbiAgICBwdWJsaWMgY2Fwc3VsZSA6IGFueTtcbiAgICBwdWJsaWMgY2Fwc3VsZUFycmF5IDogYW55O1xuICAgIHB1YmxpYyBvYmplY3RDb3VudDpudW1iZXIgPSAwO1xuICAgIHB1YmxpYyBjaGVja1BvaW50UHJlZml4OnN0cmluZyA9IFwiVGltZSBNYWNoaW5lIENoZWNrcG9pbnQgXCI7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy52ZXJzaW9uRGF0ZSA9IERhdGUoKTtcbiAgICAgICAgdGhpcy52ZXJzaW9uSUQgPSBSYW5kb20uaWQoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVzdG9yZShpZDpzdHJpbmcpIHtcbiAgICAgICAgTWV0ZW9yLmNhbGwoXCJsb2FkVGltZU1hY2hpbmVcIiwgaWQpO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0VmVyc2lvbigpOnN0cmluZyB7XG4gICAgICAgIHJldHVybiBcIlZlcnNpb24gSUQgPSBcIiArIHRoaXMudmVyc2lvbklEICsgXCIgRGF0ZSA9IFwiICsgdGhpcy5nZXREYXRlKCkudG9Mb2NhbGVEYXRlU3RyaW5nO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0RGF0ZSgpOiBEYXRlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudmVyc2lvbkRhdGU7XG4gICAgfVxuICAgIHB1YmxpYyBnZXRWZXJzaW9uTmFtZSgpOnN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmNoZWNrUG9pbnRQcmVmaXggKyB0aGlzLmdldERhdGUoKS50b0RhdGVTdHJpbmcoKSArIFwiIFwiICsgdGhpcy5nZXREYXRlKCkudG9UaW1lU3RyaW5nKCk7XG4gICAgfVxuICAgIHB1YmxpYyBDaGVja3BvaW50KCkge1xuICAgICAgICBNZXRlb3IuY2FsbChcImNoZWNrcG9pbnRUaW1lTWFjaGluZVwiKTtcbiAgICB9XG4gICAgcHVibGljIGNoZWNrUG9pbnRTZXJ2ZXIoY2hlY2tQb2ludFByZWZpeD86c3RyaW5nKSB7XG4gICAgIC8qXG4gICAgICAgIGlmIChjaGVja1BvaW50UHJlZml4KSB7XG4gICAgICAgICAgICB0aGlzLmNoZWNrUG9pbnRQcmVmaXggPSBjaGVja1BvaW50UHJlZml4XG4gICAgICAgIH1cbiAgICAgICAgQXBwTG9nLmluZm8oXCJUaW1lIE1hY2hpbmUgU2F2ZUFsbCBDYWxsZWQgPSBcIiArIHRoaXMuZ2V0VmVyc2lvbigpKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuanNvbkFycmF5ID0gbmV3IEFycmF5PGFueT4oKTtcbiAgICAgICAgICAgIGZvciAodmFyIGl0ZW0gaW4gRmFjdG9yeS5jb2xsZWN0aW9uQXJyYXkpIHtcbiAgICAgICAgICAgICAgICB2YXIgb2JqZWN0U3BlYyA9IChGYWN0b3J5LmNvbGxlY3Rpb25BcnJheVtpdGVtXSk7XG4gICAgICAgICAgICAgICAgaWYgKG9iamVjdFNwZWMudGltZUNhcHN1bGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXNoQ29sbGVjdGlvbihvYmplY3RTcGVjLmNsYXNzVHlwZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGNhcHN1bGVTdHJpbmc6c3RyaW5nID0gRUpTT04uc3RyaW5naWZ5KFZpZGVvQXBwLkVKU09OY2FzdCh0aGlzLmpzb25BcnJheSkpO1xuICAgICAgICAgICAgdmFyIHRpbWVNYWNoaW5lUHJveHk6YW55ID0gRmFjdG9yeS5DcmVhdGVQcm94eUluc3RhbmNlKENsYXNzVHlwZS5USU1FX01BQ0hJTkUpO1xuICAgICAgICAgICAgdGhpcy52ZXJzaW9uRGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICB2YXIgY2hlY2tQb2ludE9iamVjdDphbnkgPSB7XG4gICAgICAgICAgICAgICAgbmFtZTogdGhpcy5nZXRWZXJzaW9uTmFtZSgpLFxuICAgICAgICAgICAgICAgIHZlcnNpb25JRCAgICAgICA6IHRoaXMudmVyc2lvbklELFxuICAgICAgICAgICAgICAgIG9iamVjdENvdW50ICAgICA6IHRoaXMub2JqZWN0Q291bnQsXG4gICAgICAgICAgICAgICAgZGF0ZTogdGhpcy52ZXJzaW9uRGF0ZSxcbiAgICAgICAgICAgICAgICBqc29uQXJyYXk6IGNhcHN1bGVTdHJpbmdcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aW1lTWFjaGluZVByb3h5LmFkZE5ld09iamVjdChjaGVja1BvaW50T2JqZWN0KTtcbiAgICAgICAgfSBjYXRjaCAoZSkgeyBBcHBMb2cuZXJyb3IoXCJFcnJvciBXaGlsZSBTYXZpbmcgQWxsIGluIFRpbWVNYWNoaW5lXCIsIGUpO31cbiAgICAgICAgKi9cbiAgICB9XG4gICAgcHVibGljIHB1c2hDb2xsZWN0aW9uKGNsYXNzVHlwZTpDbGFzc1R5cGUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHZhciBvYmplY3RQcm94eSA9IEZhY3RvcnkuQ3JlYXRlUHJveHlJbnN0YW5jZShjbGFzc1R5cGUpO1xuICAgICAgICAgICAgdmFyIHJlY29yZHMgPSBvYmplY3RQcm94eS5nZXRMaXN0KGZhbHNlKTtcbiAgICAgICAgICAgIHRoaXMub2JqZWN0Q291bnQgKz0gcmVjb3Jkcy5sZW5ndGg7XG4gICAgICAgICAgICAvLyB2YXIgc3RyaW5neSA9IEVKU09OLnN0cmluZ2lmeShyZWNvcmRzKTtcbiAgICAgICAgICAgIHRoaXMuanNvbkFycmF5LnB1c2goe2NsYXNzVHlwZTogY2xhc3NUeXBlLCByZWNvcmRzOiByZWNvcmRzfSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIEFwcExvZy5lcnJvcihcIkVycm9yIFB1c2hpbmcgQ29sbGVjdGlvbiBmb3IgQ2xhc3NUeXBlID0gXCIgKyBjbGFzc1R5cGUsIGUpXG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIHJlc3RvcmVTZXJ2ZXIoaWQ6c3RyaW5nKSB7XG4gICAgICAgIEFwcExvZy5pbmZvKFwiVGltZU1hY2hpbmUgUmVzdG9yZUFsbCBDYWxsZWQgd2l0aCBJRCA9IFwiICsgaWQpO1xuICAgICAgICB0aGlzLmNoZWNrUG9pbnRTZXJ2ZXIoXCJDaGVja3BvaW50IEI0IHJlc3RvcmUgXCIpO1xuICAgICAgICB0aGlzLkNsZWFuREIoKTtcbiAgICAgICAvLyB2YXIgdGltZU1hY2hpbmVQcm94eSA9IEZhY3RvcnkuQ3JlYXRlUHJveHlJbnN0YW5jZShDbGFzc1R5cGUuVElNRV9NQUNISU5FKTtcbiAgICAgICAgQXBwTG9nLmluZm8oXCJUaW1lIE1hY2hpbmUgR2V0dGluZyBDYXBzdWxlIHRvIHJlc3RvcmVcIik7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLmNhcHN1bGUgPSB0aW1lTWFjaGluZVByb3h5LmdldE9uZShpZCk7XG5cbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgQXBwTG9nLmVycm9yKFwiRXJyb3IgR2V0dGluZyBUaW1lTWFjaGluZSBDYXBzdWxlIGZvciBpZCA9IFwiICsgaWQsIGUpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy5jYXBzdWxlKSB7XG4gICAgICAgICAgICBBcHBMb2cuZXJyb3IoXCJDb3VsZCBOb3QgRmluZCBUaW1lTWFjaGluZSBDYXBzdWxlIGZvciBJRCBcIiArIGlkKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNhcHN1bGVBcnJheSA9IEVKU09OLnBhcnNlKHRoaXMuY2Fwc3VsZS5qc29uQXJyYXkpO1xuICAgICAgICBBcHBMb2cuaW5mbyhcIlRpbWUgTWFjaGluZSBMb2FkaW5nIENhcHN1bGUgQ29sbGVjdGlvbnNcIik7XG4gICAgICAgIGZvciAodmFyIGk6bnVtYmVyID0gMDsgaSA8IHRoaXMuY2Fwc3VsZUFycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB0aGlzLnBvcENvbGxlY3Rpb24odGhpcy5jYXBzdWxlQXJyYXlbaV0pXG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIHBvcENvbGxlY3Rpb24odGhlUmVjb3JkOmFueSkge1xuICAgICAgICB2YXIgb2JqZWN0UHJveHkgPSBGYWN0b3J5LkNyZWF0ZVByb3h5SW5zdGFuY2UodGhlUmVjb3JkLmNsYXNzVHlwZSk7XG4gICAgICAgIEFwcExvZy5pbmZvKFwiVGltZSBNYWNoaW5lIFJlc3RvcmluZyBDb2xsZWN0aW9uIGZvciBcIiArIHRoZVJlY29yZC5jbGFzc1R5cGUpXG4gICAgICAgIHZhciBjbGFzc1R5cGU6Q2xhc3NUeXBlID0gdGhlUmVjb3JkLmNsYXNzVHlwZTtcbiAgICAgICAgaWYgKCFvYmplY3RQcm94eSkge1xuICAgICAgICAgICAgQXBwTG9nLmVycm9yKFwiQ291bGQgTm90IEZpbmQgQ29sbGVjdGlvbiBmb3IgQ2xhc3MgPSBcIiArIGNsYXNzVHlwZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhlUmVjb3JkLnJlY29yZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgb2JqZWN0UHJveHkucmVzdG9yZU9iamVjdCh0aGVSZWNvcmQucmVjb3Jkc1tpXSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7IEFwcExvZy5lcnJvcihcIlRpbWUgTWFjaGluZSBFcnJvciBJbnNlcnRpbmcgT2JqZWN0XCIsIGUsIHRoZVJlY29yZC5yZWNvcmRzW2ldKTsgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHB1YmxpYyBDbGVhbkRCKCkge1xuICAgICAgICBNZXRlb3IuY2FsbChcImNsZWFuREJcIik7XG4gICAgfVxuICAgIHB1YmxpYyBjbGVhbkRCU2VydmVyKCkge1xuICAgICAgICBBcHBMb2cucmVjb3JkKFwiQ2xlYW5pbmcgRGF0YWJhc2UgRnJvbSBTZXJ2ZXJcIiwgbmV3IEVycm9yKCksIG51bGwpO1xuICAgICAgICB0aGlzLmNoZWNrUG9pbnRTZXJ2ZXIoXCJDbGVhbkRCIENoZWNrUG9pbnQgXCIpO1xuICAgICAgICBmb3IgKHZhciBpdGVtIGluIEZhY3RvcnkuY29sbGVjdGlvbkFycmF5KSB7XG4gICAgICAgICAgICB2YXIgb2JqZWN0U3BlYz0gRmFjdG9yeS5jb2xsZWN0aW9uQXJyYXlbaXRlbV07XG4gICAgICAgICAgICBpZiAob2JqZWN0U3BlYy50aW1lQ2Fwc3VsZSkge1xuICAgICAgICAgICAgICAgIHZhciBvYmplY3RQcm94eSA9IEZhY3RvcnkuQ3JlYXRlUHJveHlJbnN0YW5jZShvYmplY3RTcGVjLmNsYXNzVHlwZSk7XG4gICAgICAgICAgICAgICAgb2JqZWN0UHJveHkucmVtb3ZlQWxsKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59dGhpcy5UaW1lTWFjaGluZUNsYXNzID0gVGltZU1hY2hpbmVDbGFzczsiXX0=