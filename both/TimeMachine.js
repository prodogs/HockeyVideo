/// <reference path="../typescript-defs/all-definitions.d.ts"/>
console.log("Loading TimeMachine.ts ...");
//endregion
class TimeMachineClass {
    constructor() {
        this.objectCount = 0;
        this.checkPointPrefix = "Time Machine Checkpoint ";
        this.versionDate = Date();
        this.versionID = Random.id();
    }
    restore(id) {
        Meteor.call("loadTimeMachine", id);
    }
    getVersion() {
        return "Version ID = " + this.versionID + " Date = " + this.getDate().toLocaleDateString;
    }
    getDate() {
        return this.versionDate;
    }
    getVersionName() {
        return this.checkPointPrefix + this.getDate().toDateString() + " " + this.getDate().toTimeString();
    }
    Checkpoint() {
        Meteor.call("checkpointTimeMachine");
    }
    checkPointServer(checkPointPrefix) {
        /*
           if (checkPointPrefix) {
               this.checkPointPrefix = checkPointPrefix
           }
           AppLog.info("Time Machine SaveAll Called = " + this.getVersion());
           try {
               this.jsonArray = new Array<any>();
               for (var item in Factory.collectionArray) {
                   var objectSpec = (Factory.collectionArray[item]);
                   if (objectSpec.timeCapsule) {
                       this.pushCollection(objectSpec.classType);
                   }
               }
               var capsuleString:string = EJSON.stringify(VideoApp.EJSONcast(this.jsonArray));
               var timeMachineProxy:any = Factory.CreateProxyInstance(ClassType.TIME_MACHINE);
               this.versionDate = new Date();
               var checkPointObject:any = {
                   name: this.getVersionName(),
                   versionID       : this.versionID,
                   objectCount     : this.objectCount,
                   date: this.versionDate,
                   jsonArray: capsuleString
               };
               timeMachineProxy.addNewObject(checkPointObject);
           } catch (e) { AppLog.error("Error While Saving All in TimeMachine", e);}
           */
    }
    pushCollection(classType) {
        try {
            var objectProxy = Factory.CreateProxyInstance(classType);
            var records = objectProxy.getList(false);
            this.objectCount += records.length;
            // var stringy = EJSON.stringify(records);
            this.jsonArray.push({ classType: classType, records: records });
        }
        catch (e) {
            AppLog.error("Error Pushing Collection for ClassType = " + classType, e);
        }
    }
    restoreServer(id) {
        AppLog.info("TimeMachine RestoreAll Called with ID = " + id);
        this.checkPointServer("Checkpoint B4 restore ");
        this.CleanDB();
        // var timeMachineProxy = Factory.CreateProxyInstance(ClassType.TIME_MACHINE);
        AppLog.info("Time Machine Getting Capsule to restore");
        try {
            this.capsule = timeMachineProxy.getOne(id);
        }
        catch (e) {
            AppLog.error("Error Getting TimeMachine Capsule for id = " + id, e);
        }
        if (!this.capsule) {
            AppLog.error("Could Not Find TimeMachine Capsule for ID " + id);
            return;
        }
        this.capsuleArray = EJSON.parse(this.capsule.jsonArray);
        AppLog.info("Time Machine Loading Capsule Collections");
        for (var i = 0; i < this.capsuleArray.length; i++) {
            this.popCollection(this.capsuleArray[i]);
        }
    }
    popCollection(theRecord) {
        var objectProxy = Factory.CreateProxyInstance(theRecord.classType);
        AppLog.info("Time Machine Restoring Collection for " + theRecord.classType);
        var classType = theRecord.classType;
        if (!objectProxy) {
            AppLog.error("Could Not Find Collection for Class = " + classType);
            return;
        }
        for (var i = 0; i < theRecord.records.length; i++) {
            try {
                objectProxy.restoreObject(theRecord.records[i]);
            }
            catch (e) {
                AppLog.error("Time Machine Error Inserting Object", e, theRecord.records[i]);
            }
        }
    }
    CleanDB() {
        Meteor.call("cleanDB");
    }
    cleanDBServer() {
        AppLog.record("Cleaning Database From Server", new Error(), null);
        this.checkPointServer("CleanDB CheckPoint ");
        for (var item in Factory.collectionArray) {
            var objectSpec = Factory.collectionArray[item];
            if (objectSpec.timeCapsule) {
                var objectProxy = Factory.CreateProxyInstance(objectSpec.classType);
                objectProxy.removeAll();
            }
        }
    }
}
this.TimeMachineClass = TimeMachineClass;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGltZU1hY2hpbmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJUaW1lTWFjaGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSwrREFBK0Q7QUFJL0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBc0IxQyxXQUFXO0FBRVg7SUFVSTtRQUhPLGdCQUFXLEdBQVUsQ0FBQyxDQUFDO1FBQ3ZCLHFCQUFnQixHQUFVLDBCQUEwQixDQUFDO1FBR3hELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDakMsQ0FBQztJQUVNLE9BQU8sQ0FBQyxFQUFTO1FBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUNNLFVBQVU7UUFDYixNQUFNLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLEdBQUcsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQztJQUM3RixDQUFDO0lBQ00sT0FBTztRQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzVCLENBQUM7SUFDTSxjQUFjO1FBQ2pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLFlBQVksRUFBRSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDdkcsQ0FBQztJQUNNLFVBQVU7UUFDYixNQUFNLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7SUFDekMsQ0FBQztJQUNNLGdCQUFnQixDQUFDLGdCQUF3QjtRQUMvQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzthQXlCSztJQUNOLENBQUM7SUFDTSxjQUFjLENBQUMsU0FBbUI7UUFD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LENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxDQUFDLEVBQUUsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQUMsQ0FBQztRQUNqRyxDQUFDO0lBQ0wsQ0FBQztJQUNNLE9BQU87UUFDVixNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFDTSxhQUFhO1FBQ2hCLE1BQU0sQ0FBQyxNQUFNLENBQUMsK0JBQStCLEVBQUUsSUFBSSxLQUFLLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUM3QyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUN2QyxJQUFJLFVBQVUsR0FBRSxPQUFPLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNwRSxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDNUIsQ0FBQztRQUNMLENBQUM7SUFDTCxDQUFDO0FBQ0wsQ0FBQztBQUFBLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBlc2NyaXB0LWRlZnMvYWxsLWRlZmluaXRpb25zLmQudHNcIi8+XHJcblxyXG5cclxuXHJcbmNvbnNvbGUubG9nKFwiTG9hZGluZyBUaW1lTWFjaGluZS50cyAuLi5cIik7XHJcblxyXG4vL3JlZ2lvbiBHbG9iYWwgVmFyaWFibGUgRGVjbGFyYXRpb25zXHJcbmRlY2xhcmUgdmFyIFRpbWVNYWNoaW5lU3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+O1xyXG5kZWNsYXJlIHZhciBDYXBhYmlsaXR5U3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+O1xyXG5kZWNsYXJlIHZhciBEaW1lbnNpb25TdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cclxuZGVjbGFyZSB2YXIgVGFza1N0b3JlOk1vbmdvLkNvbGxlY3Rpb248YW55PlxyXG5kZWNsYXJlIHZhciBTY2VuYXJpb1N0b3JlOk1vbmdvLkNvbGxlY3Rpb248YW55PlxyXG5kZWNsYXJlIHZhciBQcm9kdWN0U3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XHJcbmRlY2xhcmUgdmFyIEdvYWxTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cclxuZGVjbGFyZSB2YXIgTWV0cmljU3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XHJcbmRlY2xhcmUgdmFyIE1hcDpNb25nby5Db2xsZWN0aW9uPGFueT5cclxuZGVjbGFyZSB2YXIgQXNzZXRTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cclxuZGVjbGFyZSB2YXIgRm9sZGVyU3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XHJcbmRlY2xhcmUgdmFyIExpYnJhcnlTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cclxuZGVjbGFyZSB2YXIgRmVhdHVyZVN0b3JlOk1vbmdvLkNvbGxlY3Rpb248YW55PlxyXG5kZWNsYXJlIHZhciBJbml0aWF0aXZlU3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XHJcbmRlY2xhcmUgdmFyIFRhc2tEZXBlbmRlbmN5U3RvcmU6TW9uZ28uQ29sbGVjdGlvbjxhbnk+XHJcbmRlY2xhcmUgdmFyIE1ldHJpY1R5cGVTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cclxuZGVjbGFyZSB2YXIgQXNzZXRDYXRlZ29yeVN0b3JlOk1vbmdvLkNvbGxlY3Rpb248YW55PlxyXG5kZWNsYXJlIHZhciBQcm9kdWN0Q2F0ZWdvcnlTdG9yZTpNb25nby5Db2xsZWN0aW9uPGFueT5cclxuZGVjbGFyZSB2YXIgRGlhZ3JhbVN0b3JlOk1vbmdvLkNvbGxlY3Rpb248YW55PlxyXG4vL2VuZHJlZ2lvblxyXG5cclxuY2xhc3MgVGltZU1hY2hpbmVDbGFzcyB7XHJcblxyXG4gICAgcHVibGljIHZlcnNpb25JRDpzdHJpbmc7XHJcbiAgICBwdWJsaWMgdmVyc2lvbkRhdGU6YW55O1xyXG4gICAgcHVibGljIGpzb25BcnJheSA6IEFycmF5PGFueT47XHJcbiAgICBwdWJsaWMgY2Fwc3VsZSA6IGFueTtcclxuICAgIHB1YmxpYyBjYXBzdWxlQXJyYXkgOiBhbnk7XHJcbiAgICBwdWJsaWMgb2JqZWN0Q291bnQ6bnVtYmVyID0gMDtcclxuICAgIHB1YmxpYyBjaGVja1BvaW50UHJlZml4OnN0cmluZyA9IFwiVGltZSBNYWNoaW5lIENoZWNrcG9pbnQgXCI7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgdGhpcy52ZXJzaW9uRGF0ZSA9IERhdGUoKTtcclxuICAgICAgICB0aGlzLnZlcnNpb25JRCA9IFJhbmRvbS5pZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZXN0b3JlKGlkOnN0cmluZykge1xyXG4gICAgICAgIE1ldGVvci5jYWxsKFwibG9hZFRpbWVNYWNoaW5lXCIsIGlkKTtcclxuICAgIH1cclxuICAgIHB1YmxpYyBnZXRWZXJzaW9uKCk6c3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gXCJWZXJzaW9uIElEID0gXCIgKyB0aGlzLnZlcnNpb25JRCArIFwiIERhdGUgPSBcIiArIHRoaXMuZ2V0RGF0ZSgpLnRvTG9jYWxlRGF0ZVN0cmluZztcclxuICAgIH1cclxuICAgIHB1YmxpYyBnZXREYXRlKCk6IERhdGUge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnZlcnNpb25EYXRlO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGdldFZlcnNpb25OYW1lKCk6c3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5jaGVja1BvaW50UHJlZml4ICsgdGhpcy5nZXREYXRlKCkudG9EYXRlU3RyaW5nKCkgKyBcIiBcIiArIHRoaXMuZ2V0RGF0ZSgpLnRvVGltZVN0cmluZygpO1xyXG4gICAgfVxyXG4gICAgcHVibGljIENoZWNrcG9pbnQoKSB7XHJcbiAgICAgICAgTWV0ZW9yLmNhbGwoXCJjaGVja3BvaW50VGltZU1hY2hpbmVcIik7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgY2hlY2tQb2ludFNlcnZlcihjaGVja1BvaW50UHJlZml4PzpzdHJpbmcpIHtcclxuICAgICAvKlxyXG4gICAgICAgIGlmIChjaGVja1BvaW50UHJlZml4KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2hlY2tQb2ludFByZWZpeCA9IGNoZWNrUG9pbnRQcmVmaXhcclxuICAgICAgICB9XHJcbiAgICAgICAgQXBwTG9nLmluZm8oXCJUaW1lIE1hY2hpbmUgU2F2ZUFsbCBDYWxsZWQgPSBcIiArIHRoaXMuZ2V0VmVyc2lvbigpKTtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB0aGlzLmpzb25BcnJheSA9IG5ldyBBcnJheTxhbnk+KCk7XHJcbiAgICAgICAgICAgIGZvciAodmFyIGl0ZW0gaW4gRmFjdG9yeS5jb2xsZWN0aW9uQXJyYXkpIHtcclxuICAgICAgICAgICAgICAgIHZhciBvYmplY3RTcGVjID0gKEZhY3RvcnkuY29sbGVjdGlvbkFycmF5W2l0ZW1dKTtcclxuICAgICAgICAgICAgICAgIGlmIChvYmplY3RTcGVjLnRpbWVDYXBzdWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wdXNoQ29sbGVjdGlvbihvYmplY3RTcGVjLmNsYXNzVHlwZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFyIGNhcHN1bGVTdHJpbmc6c3RyaW5nID0gRUpTT04uc3RyaW5naWZ5KFZpZGVvQXBwLkVKU09OY2FzdCh0aGlzLmpzb25BcnJheSkpO1xyXG4gICAgICAgICAgICB2YXIgdGltZU1hY2hpbmVQcm94eTphbnkgPSBGYWN0b3J5LkNyZWF0ZVByb3h5SW5zdGFuY2UoQ2xhc3NUeXBlLlRJTUVfTUFDSElORSk7XHJcbiAgICAgICAgICAgIHRoaXMudmVyc2lvbkRhdGUgPSBuZXcgRGF0ZSgpO1xyXG4gICAgICAgICAgICB2YXIgY2hlY2tQb2ludE9iamVjdDphbnkgPSB7XHJcbiAgICAgICAgICAgICAgICBuYW1lOiB0aGlzLmdldFZlcnNpb25OYW1lKCksXHJcbiAgICAgICAgICAgICAgICB2ZXJzaW9uSUQgICAgICAgOiB0aGlzLnZlcnNpb25JRCxcclxuICAgICAgICAgICAgICAgIG9iamVjdENvdW50ICAgICA6IHRoaXMub2JqZWN0Q291bnQsXHJcbiAgICAgICAgICAgICAgICBkYXRlOiB0aGlzLnZlcnNpb25EYXRlLFxyXG4gICAgICAgICAgICAgICAganNvbkFycmF5OiBjYXBzdWxlU3RyaW5nXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRpbWVNYWNoaW5lUHJveHkuYWRkTmV3T2JqZWN0KGNoZWNrUG9pbnRPYmplY3QpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHsgQXBwTG9nLmVycm9yKFwiRXJyb3IgV2hpbGUgU2F2aW5nIEFsbCBpbiBUaW1lTWFjaGluZVwiLCBlKTt9XHJcbiAgICAgICAgKi9cclxuICAgIH1cclxuICAgIHB1YmxpYyBwdXNoQ29sbGVjdGlvbihjbGFzc1R5cGU6Q2xhc3NUeXBlKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdmFyIG9iamVjdFByb3h5ID0gRmFjdG9yeS5DcmVhdGVQcm94eUluc3RhbmNlKGNsYXNzVHlwZSk7XHJcbiAgICAgICAgICAgIHZhciByZWNvcmRzID0gb2JqZWN0UHJveHkuZ2V0TGlzdChmYWxzZSk7XHJcbiAgICAgICAgICAgIHRoaXMub2JqZWN0Q291bnQgKz0gcmVjb3Jkcy5sZW5ndGg7XHJcbiAgICAgICAgICAgIC8vIHZhciBzdHJpbmd5ID0gRUpTT04uc3RyaW5naWZ5KHJlY29yZHMpO1xyXG4gICAgICAgICAgICB0aGlzLmpzb25BcnJheS5wdXNoKHtjbGFzc1R5cGU6IGNsYXNzVHlwZSwgcmVjb3JkczogcmVjb3Jkc30pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgQXBwTG9nLmVycm9yKFwiRXJyb3IgUHVzaGluZyBDb2xsZWN0aW9uIGZvciBDbGFzc1R5cGUgPSBcIiArIGNsYXNzVHlwZSwgZSlcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgcmVzdG9yZVNlcnZlcihpZDpzdHJpbmcpIHtcclxuICAgICAgICBBcHBMb2cuaW5mbyhcIlRpbWVNYWNoaW5lIFJlc3RvcmVBbGwgQ2FsbGVkIHdpdGggSUQgPSBcIiArIGlkKTtcclxuICAgICAgICB0aGlzLmNoZWNrUG9pbnRTZXJ2ZXIoXCJDaGVja3BvaW50IEI0IHJlc3RvcmUgXCIpO1xyXG4gICAgICAgIHRoaXMuQ2xlYW5EQigpO1xyXG4gICAgICAgLy8gdmFyIHRpbWVNYWNoaW5lUHJveHkgPSBGYWN0b3J5LkNyZWF0ZVByb3h5SW5zdGFuY2UoQ2xhc3NUeXBlLlRJTUVfTUFDSElORSk7XHJcbiAgICAgICAgQXBwTG9nLmluZm8oXCJUaW1lIE1hY2hpbmUgR2V0dGluZyBDYXBzdWxlIHRvIHJlc3RvcmVcIik7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgdGhpcy5jYXBzdWxlID0gdGltZU1hY2hpbmVQcm94eS5nZXRPbmUoaWQpO1xyXG5cclxuICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIEFwcExvZy5lcnJvcihcIkVycm9yIEdldHRpbmcgVGltZU1hY2hpbmUgQ2Fwc3VsZSBmb3IgaWQgPSBcIiArIGlkLCBlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLmNhcHN1bGUpIHtcclxuICAgICAgICAgICAgQXBwTG9nLmVycm9yKFwiQ291bGQgTm90IEZpbmQgVGltZU1hY2hpbmUgQ2Fwc3VsZSBmb3IgSUQgXCIgKyBpZCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5jYXBzdWxlQXJyYXkgPSBFSlNPTi5wYXJzZSh0aGlzLmNhcHN1bGUuanNvbkFycmF5KTtcclxuICAgICAgICBBcHBMb2cuaW5mbyhcIlRpbWUgTWFjaGluZSBMb2FkaW5nIENhcHN1bGUgQ29sbGVjdGlvbnNcIik7XHJcbiAgICAgICAgZm9yICh2YXIgaTpudW1iZXIgPSAwOyBpIDwgdGhpcy5jYXBzdWxlQXJyYXkubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgdGhpcy5wb3BDb2xsZWN0aW9uKHRoaXMuY2Fwc3VsZUFycmF5W2ldKVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHB1YmxpYyBwb3BDb2xsZWN0aW9uKHRoZVJlY29yZDphbnkpIHtcclxuICAgICAgICB2YXIgb2JqZWN0UHJveHkgPSBGYWN0b3J5LkNyZWF0ZVByb3h5SW5zdGFuY2UodGhlUmVjb3JkLmNsYXNzVHlwZSk7XHJcbiAgICAgICAgQXBwTG9nLmluZm8oXCJUaW1lIE1hY2hpbmUgUmVzdG9yaW5nIENvbGxlY3Rpb24gZm9yIFwiICsgdGhlUmVjb3JkLmNsYXNzVHlwZSlcclxuICAgICAgICB2YXIgY2xhc3NUeXBlOkNsYXNzVHlwZSA9IHRoZVJlY29yZC5jbGFzc1R5cGU7XHJcbiAgICAgICAgaWYgKCFvYmplY3RQcm94eSkge1xyXG4gICAgICAgICAgICBBcHBMb2cuZXJyb3IoXCJDb3VsZCBOb3QgRmluZCBDb2xsZWN0aW9uIGZvciBDbGFzcyA9IFwiICsgY2xhc3NUeXBlKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmb3IgKHZhciBpOm51bWJlciA9IDA7IGkgPCB0aGVSZWNvcmQucmVjb3Jkcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgb2JqZWN0UHJveHkucmVzdG9yZU9iamVjdCh0aGVSZWNvcmQucmVjb3Jkc1tpXSk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgQXBwTG9nLmVycm9yKFwiVGltZSBNYWNoaW5lIEVycm9yIEluc2VydGluZyBPYmplY3RcIiwgZSwgdGhlUmVjb3JkLnJlY29yZHNbaV0pOyB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHVibGljIENsZWFuREIoKSB7XHJcbiAgICAgICAgTWV0ZW9yLmNhbGwoXCJjbGVhbkRCXCIpO1xyXG4gICAgfVxyXG4gICAgcHVibGljIGNsZWFuREJTZXJ2ZXIoKSB7XHJcbiAgICAgICAgQXBwTG9nLnJlY29yZChcIkNsZWFuaW5nIERhdGFiYXNlIEZyb20gU2VydmVyXCIsIG5ldyBFcnJvcigpLCBudWxsKTtcclxuICAgICAgICB0aGlzLmNoZWNrUG9pbnRTZXJ2ZXIoXCJDbGVhbkRCIENoZWNrUG9pbnQgXCIpO1xyXG4gICAgICAgIGZvciAodmFyIGl0ZW0gaW4gRmFjdG9yeS5jb2xsZWN0aW9uQXJyYXkpIHtcclxuICAgICAgICAgICAgdmFyIG9iamVjdFNwZWM9IEZhY3RvcnkuY29sbGVjdGlvbkFycmF5W2l0ZW1dO1xyXG4gICAgICAgICAgICBpZiAob2JqZWN0U3BlYy50aW1lQ2Fwc3VsZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIG9iamVjdFByb3h5ID0gRmFjdG9yeS5DcmVhdGVQcm94eUluc3RhbmNlKG9iamVjdFNwZWMuY2xhc3NUeXBlKTtcclxuICAgICAgICAgICAgICAgIG9iamVjdFByb3h5LnJlbW92ZUFsbCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59dGhpcy5UaW1lTWFjaGluZUNsYXNzID0gVGltZU1hY2hpbmVDbGFzczsiXX0=