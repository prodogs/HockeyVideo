/// <reference path="../../Video/typescript-defs/all-definitions.d.ts"/>
console.log("Loading ObjectUpdateRouter.ts ...");
class ObjectUpdateStats {
    constructor() {
        this.counter = 0;
    }
}
this.ObjectUpdateStats = ObjectUpdateStats;
class ObjectUpdateRouter extends C4Object {
    constructor() {
        super();
        ObjectUpdateRouter.observerInstance = this;
        this.handleArray = new Array();
        if (this.handleList == null)
            this.handleList = Factory.GetClassesToObserve();
        if (this.observations == null) {
            this.observations = new Array();
            for (var item in this.handleList) {
                this.observations[this.handleList[item]] = new Object();
                this.observations[this.handleList[item]] = ObjectUpdateRouter.CreateStatObject();
            }
        }
    }
    get observing() {
        return ObjectUpdateRouter._observing;
    }
    static SendObjectChange(object) {
        var changeMessage = new ObjectChangeMessage();
        //	MyApp.ObjectRouter.observations[object.classType]["change"].counter++;
        changeMessage.object = object;
        changeMessage.changeType = ObjectChangeType.Change;
        changeMessage.classType = object.classType;
        changeMessage.origin = "router";
        C4Event.emit(c4e.ObjectChanged, changeMessage);
    }
    static SendRemoveObject(id, classType) {
        var changeMessage = new ObjectChangeMessage();
        //MyApp.ObjectRouter.observations[<string>classType]["remove"].counter++;
        changeMessage.object = null;
        changeMessage.changeType = ObjectChangeType.Remove;
        changeMessage.classType = classType;
        changeMessage.origin = "router";
        changeMessage.removeID = id;
        C4Event.emit(c4e.ObjectChanged, changeMessage);
    }
    static SendAddObject(object) {
        var changeMessage = new ObjectChangeMessage();
        //MyApp.ObjectRouter.observations[object.classType]["add"].counter++;
        changeMessage.object = object;
        changeMessage.changeType = ObjectChangeType.New;
        changeMessage.classType = object.classType;
        changeMessage.origin = "router";
        C4Event.emit(c4e.ObjectChanged, changeMessage);
    }
    static StartObservations() {
        if (this._observing)
            return;
        this.observerInstance = new ObjectUpdateRouter();
        this.observerInstance.startObservations();
        return this.observerInstance;
    }
    static StopObservations() {
        this.observerInstance.stopObserve();
    }
    observe() {
        if (ObjectUpdateRouter._observing)
            return;
        this.startObservations();
    }
    static CreateStatObject() {
        var newObject = new Array();
        newObject["add"] = new ObjectUpdateStats();
        newObject["remove"] = new ObjectUpdateStats();
        newObject["change"] = new ObjectUpdateStats();
        return newObject;
    }
    startObservations() {
        ObjectUpdateRouter.observeRouterCount++;
        this.observations = new Array();
        for (var item in this.handleList) {
            console.log("Observing Class " + this.handleList[item]);
            this.observeClass(this.handleList[item]);
        }
        ObjectUpdateRouter._observing = true;
    }
    observeClass(classType) {
        var objectProxy = Factory.CreateProxyInstance(classType);
        VideoApp.assert(objectProxy != null, "Expected A Proxy and Got Null for classType = " + classType, new Error());
        var query = objectProxy.observe();
        VideoApp.assert(query != null, "Error Starting Observation = " + classType, new Error());
        this.handleArray[classType] =
            query.observeChanges({
                added: function (id, fields) {
                    var theObject = Factory.CreateProxyInstance(classType).getOne(id);
                    ObjectUpdateRouter.SendAddObject(theObject);
                },
                changed: function (id, fields) {
                    var object = Factory.CreateProxyInstance(classType).getOne(id);
                    ObjectUpdateRouter.SendObjectChange(object);
                },
                removed: function (id) {
                    UI.Info("Remove ---" + classType);
                    ObjectUpdateRouter.SendRemoveObject(id, classType);
                }
            });
    }
    stopObserve() {
        if (!ObjectUpdateRouter._observing)
            return;
        ObjectUpdateRouter.observeRouterCount--;
        for (var observations in this.handleArray) {
            this.handleArray[observations].stop();
        }
        ObjectUpdateRouter._observing = false;
    }
    destructor() {
        if (!ObjectUpdateRouter._observing)
            return;
        this.stopObserve();
    }
}
ObjectUpdateRouter.observeRouterCount = 0;
ObjectUpdateRouter.observerInstance = null;
ObjectUpdateRouter._observing = false;
this.ObjectUpdateRouter = ObjectUpdateRouter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2JqZWN0VXBkYXRlUm91dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiT2JqZWN0VXBkYXRlUm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHdFQUF3RTtBQUV4RSxPQUFPLENBQUMsR0FBRyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7QUFDakQ7SUFBQTtRQUVDLFlBQU8sR0FBVSxDQUFDLENBQUM7SUFDcEIsQ0FBQztBQUFELENBQUM7QUFBRSxJQUFJLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7QUFFOUMsaUNBQWlDLFFBQVE7SUFheEM7UUFDQyxPQUFPLENBQUM7UUFDUixrQkFBa0IsQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFDM0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEtBQUssRUFBTyxDQUFDO1FBQ3BDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDO1lBQzNCLElBQUksQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDakQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxLQUFLLEVBQU8sQ0FBQztZQUNyQyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDbEMsSUFBSSxDQUFDLFlBQVksQ0FBUyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDaEUsSUFBSSxDQUFDLFlBQVksQ0FBUyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUMxRixDQUFDO1FBQ0YsQ0FBQztJQUNGLENBQUM7SUFoQkQsSUFBSSxTQUFT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QUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQy9ELGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN6QyxDQUFDO2dCQUNiLE9BQU8sRUFBRyxVQUFVLEVBQUU7b0JBQ2IsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ2hDLGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQTtnQkFBQyxDQUFDO2FBQzdDLENBQUMsQ0FBQTtJQUN2QixDQUFDO0lBQ00sV0FBVztRQUNqQixFQUFFLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQztZQUFDLE1BQU0sQ0FBQztRQUMzQyxrQkFBa0IsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQ3hDLEdBQUcsQ0FBQyxDQUFDLElBQUksWUFBWSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkMsQ0FBQztRQUNELGtCQUFrQixDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7SUFDdkMsQ0FBQztJQUNELFVBQVU7UUFDVCxFQUFFLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQztZQUFDLE1BQU0sQ0FBQztRQUMzQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDcEIsQ0FBQztBQUNGLENBQUM7QUFsSGUscUNBQWtCLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLG1DQUFnQixHQUFLLElBQUksQ0FBQztBQUMxQiw2QkFBVSxHQUFXLEtBQUssQ0FnSHpDO0FBQ0QsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL1ZpZGVvL3R5cGVzY3JpcHQtZGVmcy9hbGwtZGVmaW5pdGlvbnMuZC50c1wiLz5cblxuY29uc29sZS5sb2coXCJMb2FkaW5nIE9iamVjdFVwZGF0ZVJvdXRlci50cyAuLi5cIik7XG5jbGFzcyBPYmplY3RVcGRhdGVTdGF0cyB7XG5cdHR5cGU6c3RyaW5nO1xuXHRjb3VudGVyOm51bWJlciA9IDA7XG59ICB0aGlzLk9iamVjdFVwZGF0ZVN0YXRzID0gT2JqZWN0VXBkYXRlU3RhdHM7XG5cbmNsYXNzIE9iamVjdFVwZGF0ZVJvdXRlciBleHRlbmRzIEM0T2JqZWN0IHtcblxuXHRwcml2YXRlIHN0YXRpYyBvYnNlcnZlUm91dGVyQ291bnQgPSAwO1xuXHRwcml2YXRlIHN0YXRpYyBvYnNlcnZlckluc3RhbmNlICAgPSBudWxsO1xuXHRwcml2YXRlIHN0YXRpYyBfb2JzZXJ2aW5nICAgICAgICAgPSBmYWxzZTtcblx0cHVibGljICBvYnNlcnZhdGlvbnM6QXJyYXk8YW55Pjtcblx0cHJpdmF0ZSBoYW5kbGVBcnJheTpBcnJheTxhbnk+O1xuXHRwcml2YXRlIGhhbmRsZUxpc3Q6QXJyYXk8Q2xhc3NUeXBlPjtcblx0cHVibGljIHByb2R1Y3RIYW5kbGU6YW55O1xuXG5cdGdldCBvYnNlcnZpbmcoKTpib29sZWFuIHtcblx0XHRyZXR1cm4gT2JqZWN0VXBkYXRlUm91dGVyLl9vYnNlcnZpbmc7XG5cdH1cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0c3VwZXIoKTtcblx0XHRPYmplY3RVcGRhdGVSb3V0ZXIub2JzZXJ2ZXJJbnN0YW5jZSA9IHRoaXM7XG5cdFx0dGhpcy5oYW5kbGVBcnJheSA9IG5ldyBBcnJheTxhbnk+KCk7XG5cdFx0aWYgKHRoaXMuaGFuZGxlTGlzdCA9PSBudWxsKVxuXHRcdFx0dGhpcy5oYW5kbGVMaXN0ID0gRmFjdG9yeS5HZXRDbGFzc2VzVG9PYnNlcnZlKCk7XG5cdFx0aWYgKHRoaXMub2JzZXJ2YXRpb25zID09IG51bGwpIHtcblx0XHRcdHRoaXMub2JzZXJ2YXRpb25zID0gbmV3IEFycmF5PGFueT4oKTtcblx0XHRcdGZvciAodmFyIGl0ZW0gaW4gdGhpcy5oYW5kbGVMaXN0KSB7XG5cdFx0XHRcdHRoaXMub2JzZXJ2YXRpb25zWzxzdHJpbmc+dGhpcy5oYW5kbGVMaXN0W2l0ZW1dXSA9IG5ldyBPYmplY3QoKTtcblx0XHRcdFx0dGhpcy5vYnNlcnZhdGlvbnNbPHN0cmluZz50aGlzLmhhbmRsZUxpc3RbaXRlbV1dID0gT2JqZWN0VXBkYXRlUm91dGVyLkNyZWF0ZVN0YXRPYmplY3QoKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblx0cHVibGljIHN0YXRpYyBTZW5kT2JqZWN0Q2hhbmdlKG9iamVjdDphbnkpIHtcblx0XHR2YXIgY2hhbmdlTWVzc2FnZSA9IG5ldyBPYmplY3RDaGFuZ2VNZXNzYWdlKCk7XG5cdC8vXHRNeUFwcC5PYmplY3RSb3V0ZXIub2JzZXJ2YXRpb25zW29iamVjdC5jbGFzc1R5cGVdW1wiY2hhbmdlXCJdLmNvdW50ZXIrKztcblx0XHRjaGFuZ2VNZXNzYWdlLm9iamVjdCAgICAgPSBvYmplY3Q7XG5cdFx0Y2hhbmdlTWVzc2FnZS5jaGFuZ2VUeXBlID0gT2JqZWN0Q2hhbmdlVHlwZS5DaGFuZ2U7XG5cdFx0Y2hhbmdlTWVzc2FnZS5jbGFzc1R5cGUgID0gb2JqZWN0LmNsYXNzVHlwZVxuXHRcdGNoYW5nZU1lc3NhZ2Uub3JpZ2luICAgICA9IFwicm91dGVyXCI7XG5cdFx0QzRFdmVudC5lbWl0KGM0ZS5PYmplY3RDaGFuZ2VkLCBjaGFuZ2VNZXNzYWdlKTtcblx0fVxuXHRwdWJsaWMgc3RhdGljIFNlbmRSZW1vdmVPYmplY3QoaWQ6c3RyaW5nLCBjbGFzc1R5cGU6Q2xhc3NUeXBlKSB7XG5cdFx0dmFyIGNoYW5nZU1lc3NhZ2UgPSBuZXcgT2JqZWN0Q2hhbmdlTWVzc2FnZSgpO1xuXHRcdC8vTXlBcHAuT2JqZWN0Um91dGVyLm9ic2VydmF0aW9uc1s8c3RyaW5nPmNsYXNzVHlwZV1bXCJyZW1vdmVcIl0uY291bnRlcisrO1xuXHRcdGNoYW5nZU1lc3NhZ2Uub2JqZWN0ID0gbnVsbDtcblx0XHRjaGFuZ2VNZXNzYWdlLmNoYW5nZVR5cGUgPSBPYmplY3RDaGFuZ2VUeXBlLlJlbW92ZTtcblx0XHRjaGFuZ2VNZXNzYWdlLmNsYXNzVHlwZSAgPSBjbGFzc1R5cGU7XG5cdFx0Y2hhbmdlTWVzc2FnZS5vcmlnaW4gICAgID0gXCJyb3V0ZXJcIjtcblx0XHRjaGFuZ2VNZXNzYWdlLnJlbW92ZUlEICAgPSBpZDtcblx0XHRDNEV2ZW50LmVtaXQoYzRlLk9iamVjdENoYW5nZWQsIGNoYW5nZU1lc3NhZ2UpO1xuXHR9XG5cdHB1YmxpYyBzdGF0aWMgU2VuZEFkZE9iamVjdChvYmplY3Q6YW55KSB7XG5cdFx0dmFyIGNoYW5nZU1lc3NhZ2UgPSBuZXcgT2JqZWN0Q2hhbmdlTWVzc2FnZSgpO1xuXHRcdC8vTXlBcHAuT2JqZWN0Um91dGVyLm9ic2VydmF0aW9uc1tvYmplY3QuY2xhc3NUeXBlXVtcImFkZFwiXS5jb3VudGVyKys7XG5cdFx0Y2hhbmdlTWVzc2FnZS5vYmplY3QgICAgID0gb2JqZWN0O1xuXHRcdGNoYW5nZU1lc3NhZ2UuY2hhbmdlVHlwZSA9IE9iamVjdENoYW5nZVR5cGUuTmV3O1xuXHRcdGNoYW5nZU1lc3NhZ2UuY2xhc3NUeXBlICA9IG9iamVjdC5jbGFzc1R5cGVcblx0XHRjaGFuZ2VNZXNzYWdlLm9yaWdpbiAgICAgPSBcInJvdXRlclwiO1xuXHRcdEM0RXZlbnQuZW1pdChjNGUuT2JqZWN0Q2hhbmdlZCwgY2hhbmdlTWVzc2FnZSk7XG5cdH1cblx0cHVibGljIHN0YXRpYyBTdGFydE9ic2VydmF0aW9ucygpIDogT2JqZWN0VXBkYXRlUm91dGVyIHtcblx0XHRpZiAodGhpcy5fb2JzZXJ2aW5nKSByZXR1cm47XG5cdFx0dGhpcy5vYnNlcnZlckluc3RhbmNlID0gbmV3IE9iamVjdFVwZGF0ZVJvdXRlcigpO1xuXHRcdHRoaXMub2JzZXJ2ZXJJbnN0YW5jZS5zdGFydE9ic2VydmF0aW9ucygpO1xuXHRcdHJldHVybiB0aGlzLm9ic2VydmVySW5zdGFuY2U7XG5cdH1cblx0cHVibGljIHN0YXRpYyBTdG9wT2JzZXJ2YXRpb25zKCkge1xuXHRcdHRoaXMub2JzZXJ2ZXJJbnN0YW5jZS5zdG9wT2JzZXJ2ZSgpO1xuXHR9XG5cdHB1YmxpYyBvYnNlcnZlKCkge1xuXHRcdGlmIChPYmplY3RVcGRhdGVSb3V0ZXIuX29ic2VydmluZykgcmV0dXJuO1xuXHRcdHRoaXMuc3RhcnRPYnNlcnZhdGlvbnMoKTtcblx0fVxuXHRwdWJsaWMgc3RhdGljIENyZWF0ZVN0YXRPYmplY3QoKTphbnkge1xuXHRcdHZhciBuZXdPYmplY3QgICAgICAgPSBuZXcgQXJyYXk8T2JqZWN0VXBkYXRlU3RhdHM+KCk7XG5cdFx0bmV3T2JqZWN0W1wiYWRkXCJdICAgID0gbmV3IE9iamVjdFVwZGF0ZVN0YXRzKCk7XG5cdFx0bmV3T2JqZWN0W1wicmVtb3ZlXCJdID0gbmV3IE9iamVjdFVwZGF0ZVN0YXRzKCk7XG5cdFx0bmV3T2JqZWN0W1wiY2hhbmdlXCJdID0gbmV3IE9iamVjdFVwZGF0ZVN0YXRzKCk7XG5cdFx0cmV0dXJuIG5ld09iamVjdDtcblx0fVxuXHRwdWJsaWMgc3RhcnRPYnNlcnZhdGlvbnMoKSB7XG5cdFx0T2JqZWN0VXBkYXRlUm91dGVyLm9ic2VydmVSb3V0ZXJDb3VudCsrXG5cdFx0dGhpcy5vYnNlcnZhdGlvbnMgPSBuZXcgQXJyYXk8YW55PigpO1xuXHRcdGZvciAodmFyIGl0ZW0gaW4gdGhpcy5oYW5kbGVMaXN0KSB7XG5cdFx0XHRjb25zb2xlLmxvZyhcIk9ic2VydmluZyBDbGFzcyBcIit0aGlzLmhhbmRsZUxpc3RbaXRlbV0pXG5cdFx0XHR0aGlzLm9ic2VydmVDbGFzcyh0aGlzLmhhbmRsZUxpc3RbaXRlbV0pXG5cdFx0fVxuXHRcdE9iamVjdFVwZGF0ZVJvdXRlci5fb2JzZXJ2aW5nID0gdHJ1ZTtcblx0fVxuXHRwdWJsaWMgb2JzZXJ2ZUNsYXNzKGNsYXNzVHlwZTpDbGFzc1R5cGUpIHtcblx0XHR2YXIgb2JqZWN0UHJveHkgPSBGYWN0b3J5LkNyZWF0ZVByb3h5SW5zdGFuY2UoY2xhc3NUeXBlKTtcblx0XHRWaWRlb0FwcC5hc3NlcnQob2JqZWN0UHJveHkgIT0gbnVsbCwgXCJFeHBlY3RlZCBBIFByb3h5IGFuZCBHb3QgTnVsbCBmb3IgY2xhc3NUeXBlID0gXCIgKyBjbGFzc1R5cGUsIG5ldyBFcnJvcigpKTtcblx0XHR2YXIgcXVlcnkgPSBvYmplY3RQcm94eS5vYnNlcnZlKCk7XG5cdFx0VmlkZW9BcHAuYXNzZXJ0KHF1ZXJ5ICE9IG51bGwsIFwiRXJyb3IgU3RhcnRpbmcgT2JzZXJ2YXRpb24gPSBcIiArIGNsYXNzVHlwZSwgbmV3IEVycm9yKCkpO1xuXHRcdHRoaXMuaGFuZGxlQXJyYXlbPHN0cmluZz5jbGFzc1R5cGVdID1cblx0XHRcdHF1ZXJ5Lm9ic2VydmVDaGFuZ2VzKHtcblx0XHRcdFx0YWRkZWQgIDogZnVuY3Rpb24gKGlkLCBmaWVsZHMpIHtcblx0XHRcdFx0XHRcdFx0dmFyIHRoZU9iamVjdCA9IEZhY3RvcnkuQ3JlYXRlUHJveHlJbnN0YW5jZShjbGFzc1R5cGUpLmdldE9uZShpZCk7XG5cdFx0XHRcdCAgICAgICAgICAgIE9iamVjdFVwZGF0ZVJvdXRlci5TZW5kQWRkT2JqZWN0KHRoZU9iamVjdCk7XG5cdFx0XHQgICAgICAgICAgICAgICAgfSxcblx0XHRcdCAgICBjaGFuZ2VkIDogZnVuY3Rpb24gKGlkLCBmaWVsZHMpIHtcblx0XHRcdFx0ICAgICAgICAgICAgdmFyIG9iamVjdCA9IEZhY3RvcnkuQ3JlYXRlUHJveHlJbnN0YW5jZShjbGFzc1R5cGUpLmdldE9uZShpZCk7XG5cdFx0XHRcdCAgICAgICAgICAgIE9iamVjdFVwZGF0ZVJvdXRlci5TZW5kT2JqZWN0Q2hhbmdlKG9iamVjdCk7XG5cdFx0XHQgICAgICAgICAgICAgICAgfSxcblx0XHRcdCAgICByZW1vdmVkIDogZnVuY3Rpb24gKGlkKSB7XG5cdFx0XHRcdCAgICAgICAgICAgIFVJLkluZm8oXCJSZW1vdmUgLS0tXCIrY2xhc3NUeXBlKTtcblx0XHRcdFx0ICAgICAgICAgICAgT2JqZWN0VXBkYXRlUm91dGVyLlNlbmRSZW1vdmVPYmplY3QoaWQsIGNsYXNzVHlwZSkgfVxuXHRcdCAgICAgICAgICAgICAgICAgICAgfSlcblx0fVxuXHRwdWJsaWMgc3RvcE9ic2VydmUoKSB7XG5cdFx0aWYgKCFPYmplY3RVcGRhdGVSb3V0ZXIuX29ic2VydmluZykgcmV0dXJuO1xuXHRcdE9iamVjdFVwZGF0ZVJvdXRlci5vYnNlcnZlUm91dGVyQ291bnQtLTtcblx0XHRmb3IgKHZhciBvYnNlcnZhdGlvbnMgaW4gdGhpcy5oYW5kbGVBcnJheSkge1xuXHRcdFx0dGhpcy5oYW5kbGVBcnJheVtvYnNlcnZhdGlvbnNdLnN0b3AoKTtcblx0XHR9XG5cdFx0T2JqZWN0VXBkYXRlUm91dGVyLl9vYnNlcnZpbmcgPSBmYWxzZTtcblx0fVxuXHRkZXN0cnVjdG9yKCkge1xuXHRcdGlmICghT2JqZWN0VXBkYXRlUm91dGVyLl9vYnNlcnZpbmcpIHJldHVybjtcblx0XHR0aGlzLnN0b3BPYnNlcnZlKCk7XG5cdH1cbn1cbnRoaXMuT2JqZWN0VXBkYXRlUm91dGVyID0gT2JqZWN0VXBkYXRlUm91dGVyO1xuIl19