/// <reference path="../../Video/typescript-defs/all-definitions.d.ts"/>
console.log("Loading ObjectUpdateRouter.ts ...");
class ObjectUpdateStats {
    constructor() {
        this.counter = 0;
    }
}
this.ObjectUpdateStats = ObjectUpdateStats;
class ObjectUpdateRouter extends C4Object {
    constructor() {
        super();
        ObjectUpdateRouter.observerInstance = this;
        this.handleArray = new Array();
        if (this.handleList == null)
            this.handleList = Factory.GetClassesToObserve();
        if (this.observations == null) {
            this.observations = new Array();
            for (var item in this.handleList) {
                this.observations[this.handleList[item]] = new Object();
                this.observations[this.handleList[item]] = ObjectUpdateRouter.CreateStatObject();
            }
        }
    }
    get observing() {
        return ObjectUpdateRouter._observing;
    }
    static SendObjectChange(object) {
        var changeMessage = new ObjectChangeMessage();
        //	MyApp.ObjectRouter.observations[object.classType]["change"].counter++;
        changeMessage.object = object;
        changeMessage.changeType = ObjectChangeType.Change;
        changeMessage.classType = object.classType;
        changeMessage.origin = "router";
        C4Event.emit(c4e.ObjectChanged, changeMessage);
    }
    static SendRemoveObject(id, classType) {
        var changeMessage = new ObjectChangeMessage();
        //MyApp.ObjectRouter.observations[<string>classType]["remove"].counter++;
        changeMessage.object = null;
        changeMessage.changeType = ObjectChangeType.Remove;
        changeMessage.classType = classType;
        changeMessage.origin = "router";
        changeMessage.removeID = id;
        C4Event.emit(c4e.ObjectChanged, changeMessage);
    }
    static SendAddObject(object) {
        var changeMessage = new ObjectChangeMessage();
        //MyApp.ObjectRouter.observations[object.classType]["add"].counter++;
        changeMessage.object = object;
        changeMessage.changeType = ObjectChangeType.New;
        changeMessage.classType = object.classType;
        changeMessage.origin = "router";
        C4Event.emit(c4e.ObjectChanged, changeMessage);
    }
    static StartObservations() {
        if (this._observing)
            return;
        this.observerInstance = new ObjectUpdateRouter();
        this.observerInstance.startObservations();
        return this.observerInstance;
    }
    static StopObservations() {
        this.observerInstance.stopObserve();
    }
    observe() {
        if (ObjectUpdateRouter._observing)
            return;
        this.startObservations();
    }
    static CreateStatObject() {
        var newObject = new Array();
        newObject["add"] = new ObjectUpdateStats();
        newObject["remove"] = new ObjectUpdateStats();
        newObject["change"] = new ObjectUpdateStats();
        return newObject;
    }
    startObservations() {
        ObjectUpdateRouter.observeRouterCount++;
        this.observations = new Array();
        for (var item in this.handleList) {
            console.log("Observing Class " + this.handleList[item]);
            this.observeClass(this.handleList[item]);
        }
        ObjectUpdateRouter._observing = true;
    }
    observeClass(classType) {
        var objectProxy = Factory.CreateProxyInstance(classType);
        VideoApp.assert(objectProxy != null, "Expected A Proxy and Got Null for classType = " + classType, new Error());
        var query = objectProxy.observe();
        VideoApp.assert(query != null, "Error Starting Observation = " + classType, new Error());
        this.handleArray[classType] =
            query.observeChanges({
                added: function (id, fields) {
                    var theObject = Factory.CreateProxyInstance(classType).getOne(id);
                    ObjectUpdateRouter.SendAddObject(theObject);
                },
                changed: function (id, fields) {
                    var object = Factory.CreateProxyInstance(classType).getOne(id);
                    ObjectUpdateRouter.SendObjectChange(object);
                },
                removed: function (id) {
                    UI.Info("Remove ---" + classType);
                    ObjectUpdateRouter.SendRemoveObject(id, classType);
                }
            });
    }
    stopObserve() {
        if (!ObjectUpdateRouter._observing)
            return;
        ObjectUpdateRouter.observeRouterCount--;
        for (var observations in this.handleArray) {
            this.handleArray[observations].stop();
        }
        ObjectUpdateRouter._observing = false;
    }
    destructor() {
        if (!ObjectUpdateRouter._observing)
            return;
        this.stopObserve();
    }
}
ObjectUpdateRouter.observeRouterCount = 0;
ObjectUpdateRouter.observerInstance = null;
ObjectUpdateRouter._observing = false;
this.ObjectUpdateRouter = ObjectUpdateRouter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT2JqZWN0VXBkYXRlUm91dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiT2JqZWN0VXBkYXRlUm91dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHdFQUF3RTtBQUV4RSxPQUFPLENBQUMsR0FBRyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7QUFDakQ7SUFBQTtRQUVDLFlBQU8sR0FBVSxDQUFDLENBQUM7SUFDcEIsQ0FBQztBQUFELENBQUM7QUFBRSxJQUFJLENBQUMsaUJBQWlCLEdBQUcsaUJBQWlCLENBQUM7QUFFOUMsaUNBQWlDLFFBQVE7SUFheEM7UUFDQyxPQUFPLENBQUM7UUFDUixrQkFBa0IsQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFDM0MsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEtBQUssRUFBTyxDQUFDO1FBQ3BDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDO1lBQzNCLElBQUksQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDakQsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxLQUFLLEVBQU8sQ0FBQztZQUNyQyxHQUFHLENBQUMsQ0FBQyxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFDbEMsSUFBSSxDQUFDLFlBQVksQ0FBUyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztnQkFDaEUsSUFBSSxDQUFDLFlBQVksQ0FBUyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsa0JBQWtCLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztZQUMxRixDQUFDO1FBQ0YsQ0FBQztJQUNGLENBQUM7SUFoQkQsSUFBSSxTQUFT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QUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQy9ELGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN6QyxDQUFDO2dCQUNiLE9BQU8sRUFBRyxVQUFVLEVBQUU7b0JBQ2IsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEdBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ2hDLGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQTtnQkFBQyxDQUFDO2FBQzdDLENBQUMsQ0FBQTtJQUN2QixDQUFDO0lBQ00sV0FBVztRQUNqQixFQUFFLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQztZQUFDLE1BQU0sQ0FBQztRQUMzQyxrQkFBa0IsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1FBQ3hDLEdBQUcsQ0FBQyxDQUFDLElBQUksWUFBWSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQzNDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdkMsQ0FBQztRQUNELGtCQUFrQixDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7SUFDdkMsQ0FBQztJQUNELFVBQVU7UUFDVCxFQUFFLENBQUMsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQztZQUFDLE1BQU0sQ0FBQztRQUMzQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDcEIsQ0FBQztBQUNGLENBQUM7QUFsSGUscUNBQWtCLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZCLG1DQUFnQixHQUFLLElBQUksQ0FBQztBQUMxQiw2QkFBVSxHQUFXLEtBQUssQ0FnSHpDO0FBQ0QsSUFBSSxDQUFDLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uL1ZpZGVvL3R5cGVzY3JpcHQtZGVmcy9hbGwtZGVmaW5pdGlvbnMuZC50c1wiLz5cclxuXHJcbmNvbnNvbGUubG9nKFwiTG9hZGluZyBPYmplY3RVcGRhdGVSb3V0ZXIudHMgLi4uXCIpO1xyXG5jbGFzcyBPYmplY3RVcGRhdGVTdGF0cyB7XHJcblx0dHlwZTpzdHJpbmc7XHJcblx0Y291bnRlcjpudW1iZXIgPSAwO1xyXG59ICB0aGlzLk9iamVjdFVwZGF0ZVN0YXRzID0gT2JqZWN0VXBkYXRlU3RhdHM7XHJcblxyXG5jbGFzcyBPYmplY3RVcGRhdGVSb3V0ZXIgZXh0ZW5kcyBDNE9iamVjdCB7XHJcblxyXG5cdHByaXZhdGUgc3RhdGljIG9ic2VydmVSb3V0ZXJDb3VudCA9IDA7XHJcblx0cHJpdmF0ZSBzdGF0aWMgb2JzZXJ2ZXJJbnN0YW5jZSAgID0gbnVsbDtcclxuXHRwcml2YXRlIHN0YXRpYyBfb2JzZXJ2aW5nICAgICAgICAgPSBmYWxzZTtcclxuXHRwdWJsaWMgIG9ic2VydmF0aW9uczpBcnJheTxhbnk+O1xyXG5cdHByaXZhdGUgaGFuZGxlQXJyYXk6QXJyYXk8YW55PjtcclxuXHRwcml2YXRlIGhhbmRsZUxpc3Q6QXJyYXk8Q2xhc3NUeXBlPjtcclxuXHRwdWJsaWMgcHJvZHVjdEhhbmRsZTphbnk7XHJcblxyXG5cdGdldCBvYnNlcnZpbmcoKTpib29sZWFuIHtcclxuXHRcdHJldHVybiBPYmplY3RVcGRhdGVSb3V0ZXIuX29ic2VydmluZztcclxuXHR9XHJcblx0Y29uc3RydWN0b3IoKSB7XHJcblx0XHRzdXBlcigpO1xyXG5cdFx0T2JqZWN0VXBkYXRlUm91dGVyLm9ic2VydmVySW5zdGFuY2UgPSB0aGlzO1xyXG5cdFx0dGhpcy5oYW5kbGVBcnJheSA9IG5ldyBBcnJheTxhbnk+KCk7XHJcblx0XHRpZiAodGhpcy5oYW5kbGVMaXN0ID09IG51bGwpXHJcblx0XHRcdHRoaXMuaGFuZGxlTGlzdCA9IEZhY3RvcnkuR2V0Q2xhc3Nlc1RvT2JzZXJ2ZSgpO1xyXG5cdFx0aWYgKHRoaXMub2JzZXJ2YXRpb25zID09IG51bGwpIHtcclxuXHRcdFx0dGhpcy5vYnNlcnZhdGlvbnMgPSBuZXcgQXJyYXk8YW55PigpO1xyXG5cdFx0XHRmb3IgKHZhciBpdGVtIGluIHRoaXMuaGFuZGxlTGlzdCkge1xyXG5cdFx0XHRcdHRoaXMub2JzZXJ2YXRpb25zWzxzdHJpbmc+dGhpcy5oYW5kbGVMaXN0W2l0ZW1dXSA9IG5ldyBPYmplY3QoKTtcclxuXHRcdFx0XHR0aGlzLm9ic2VydmF0aW9uc1s8c3RyaW5nPnRoaXMuaGFuZGxlTGlzdFtpdGVtXV0gPSBPYmplY3RVcGRhdGVSb3V0ZXIuQ3JlYXRlU3RhdE9iamVjdCgpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0fVxyXG5cdHB1YmxpYyBzdGF0aWMgU2VuZE9iamVjdENoYW5nZShvYmplY3Q6YW55KSB7XHJcblx0XHR2YXIgY2hhbmdlTWVzc2FnZSA9IG5ldyBPYmplY3RDaGFuZ2VNZXNzYWdlKCk7XHJcblx0Ly9cdE15QXBwLk9iamVjdFJvdXRlci5vYnNlcnZhdGlvbnNbb2JqZWN0LmNsYXNzVHlwZV1bXCJjaGFuZ2VcIl0uY291bnRlcisrO1xyXG5cdFx0Y2hhbmdlTWVzc2FnZS5vYmplY3QgICAgID0gb2JqZWN0O1xyXG5cdFx0Y2hhbmdlTWVzc2FnZS5jaGFuZ2VUeXBlID0gT2JqZWN0Q2hhbmdlVHlwZS5DaGFuZ2U7XHJcblx0XHRjaGFuZ2VNZXNzYWdlLmNsYXNzVHlwZSAgPSBvYmplY3QuY2xhc3NUeXBlXHJcblx0XHRjaGFuZ2VNZXNzYWdlLm9yaWdpbiAgICAgPSBcInJvdXRlclwiO1xyXG5cdFx0QzRFdmVudC5lbWl0KGM0ZS5PYmplY3RDaGFuZ2VkLCBjaGFuZ2VNZXNzYWdlKTtcclxuXHR9XHJcblx0cHVibGljIHN0YXRpYyBTZW5kUmVtb3ZlT2JqZWN0KGlkOnN0cmluZywgY2xhc3NUeXBlOkNsYXNzVHlwZSkge1xyXG5cdFx0dmFyIGNoYW5nZU1lc3NhZ2UgPSBuZXcgT2JqZWN0Q2hhbmdlTWVzc2FnZSgpO1xyXG5cdFx0Ly9NeUFwcC5PYmplY3RSb3V0ZXIub2JzZXJ2YXRpb25zWzxzdHJpbmc+Y2xhc3NUeXBlXVtcInJlbW92ZVwiXS5jb3VudGVyKys7XHJcblx0XHRjaGFuZ2VNZXNzYWdlLm9iamVjdCA9IG51bGw7XHJcblx0XHRjaGFuZ2VNZXNzYWdlLmNoYW5nZVR5cGUgPSBPYmplY3RDaGFuZ2VUeXBlLlJlbW92ZTtcclxuXHRcdGNoYW5nZU1lc3NhZ2UuY2xhc3NUeXBlICA9IGNsYXNzVHlwZTtcclxuXHRcdGNoYW5nZU1lc3NhZ2Uub3JpZ2luICAgICA9IFwicm91dGVyXCI7XHJcblx0XHRjaGFuZ2VNZXNzYWdlLnJlbW92ZUlEICAgPSBpZDtcclxuXHRcdEM0RXZlbnQuZW1pdChjNGUuT2JqZWN0Q2hhbmdlZCwgY2hhbmdlTWVzc2FnZSk7XHJcblx0fVxyXG5cdHB1YmxpYyBzdGF0aWMgU2VuZEFkZE9iamVjdChvYmplY3Q6YW55KSB7XHJcblx0XHR2YXIgY2hhbmdlTWVzc2FnZSA9IG5ldyBPYmplY3RDaGFuZ2VNZXNzYWdlKCk7XHJcblx0XHQvL015QXBwLk9iamVjdFJvdXRlci5vYnNlcnZhdGlvbnNbb2JqZWN0LmNsYXNzVHlwZV1bXCJhZGRcIl0uY291bnRlcisrO1xyXG5cdFx0Y2hhbmdlTWVzc2FnZS5vYmplY3QgICAgID0gb2JqZWN0O1xyXG5cdFx0Y2hhbmdlTWVzc2FnZS5jaGFuZ2VUeXBlID0gT2JqZWN0Q2hhbmdlVHlwZS5OZXc7XHJcblx0XHRjaGFuZ2VNZXNzYWdlLmNsYXNzVHlwZSAgPSBvYmplY3QuY2xhc3NUeXBlXHJcblx0XHRjaGFuZ2VNZXNzYWdlLm9yaWdpbiAgICAgPSBcInJvdXRlclwiO1xyXG5cdFx0QzRFdmVudC5lbWl0KGM0ZS5PYmplY3RDaGFuZ2VkLCBjaGFuZ2VNZXNzYWdlKTtcclxuXHR9XHJcblx0cHVibGljIHN0YXRpYyBTdGFydE9ic2VydmF0aW9ucygpIDogT2JqZWN0VXBkYXRlUm91dGVyIHtcclxuXHRcdGlmICh0aGlzLl9vYnNlcnZpbmcpIHJldHVybjtcclxuXHRcdHRoaXMub2JzZXJ2ZXJJbnN0YW5jZSA9IG5ldyBPYmplY3RVcGRhdGVSb3V0ZXIoKTtcclxuXHRcdHRoaXMub2JzZXJ2ZXJJbnN0YW5jZS5zdGFydE9ic2VydmF0aW9ucygpO1xyXG5cdFx0cmV0dXJuIHRoaXMub2JzZXJ2ZXJJbnN0YW5jZTtcclxuXHR9XHJcblx0cHVibGljIHN0YXRpYyBTdG9wT2JzZXJ2YXRpb25zKCkge1xyXG5cdFx0dGhpcy5vYnNlcnZlckluc3RhbmNlLnN0b3BPYnNlcnZlKCk7XHJcblx0fVxyXG5cdHB1YmxpYyBvYnNlcnZlKCkge1xyXG5cdFx0aWYgKE9iamVjdFVwZGF0ZVJvdXRlci5fb2JzZXJ2aW5nKSByZXR1cm47XHJcblx0XHR0aGlzLnN0YXJ0T2JzZXJ2YXRpb25zKCk7XHJcblx0fVxyXG5cdHB1YmxpYyBzdGF0aWMgQ3JlYXRlU3RhdE9iamVjdCgpOmFueSB7XHJcblx0XHR2YXIgbmV3T2JqZWN0ICAgICAgID0gbmV3IEFycmF5PE9iamVjdFVwZGF0ZVN0YXRzPigpO1xyXG5cdFx0bmV3T2JqZWN0W1wiYWRkXCJdICAgID0gbmV3IE9iamVjdFVwZGF0ZVN0YXRzKCk7XHJcblx0XHRuZXdPYmplY3RbXCJyZW1vdmVcIl0gPSBuZXcgT2JqZWN0VXBkYXRlU3RhdHMoKTtcclxuXHRcdG5ld09iamVjdFtcImNoYW5nZVwiXSA9IG5ldyBPYmplY3RVcGRhdGVTdGF0cygpO1xyXG5cdFx0cmV0dXJuIG5ld09iamVjdDtcclxuXHR9XHJcblx0cHVibGljIHN0YXJ0T2JzZXJ2YXRpb25zKCkge1xyXG5cdFx0T2JqZWN0VXBkYXRlUm91dGVyLm9ic2VydmVSb3V0ZXJDb3VudCsrXHJcblx0XHR0aGlzLm9ic2VydmF0aW9ucyA9IG5ldyBBcnJheTxhbnk+KCk7XHJcblx0XHRmb3IgKHZhciBpdGVtIGluIHRoaXMuaGFuZGxlTGlzdCkge1xyXG5cdFx0XHRjb25zb2xlLmxvZyhcIk9ic2VydmluZyBDbGFzcyBcIit0aGlzLmhhbmRsZUxpc3RbaXRlbV0pXHJcblx0XHRcdHRoaXMub2JzZXJ2ZUNsYXNzKHRoaXMuaGFuZGxlTGlzdFtpdGVtXSlcclxuXHRcdH1cclxuXHRcdE9iamVjdFVwZGF0ZVJvdXRlci5fb2JzZXJ2aW5nID0gdHJ1ZTtcclxuXHR9XHJcblx0cHVibGljIG9ic2VydmVDbGFzcyhjbGFzc1R5cGU6Q2xhc3NUeXBlKSB7XHJcblx0XHR2YXIgb2JqZWN0UHJveHkgPSBGYWN0b3J5LkNyZWF0ZVByb3h5SW5zdGFuY2UoY2xhc3NUeXBlKTtcclxuXHRcdFZpZGVvQXBwLmFzc2VydChvYmplY3RQcm94eSAhPSBudWxsLCBcIkV4cGVjdGVkIEEgUHJveHkgYW5kIEdvdCBOdWxsIGZvciBjbGFzc1R5cGUgPSBcIiArIGNsYXNzVHlwZSwgbmV3IEVycm9yKCkpO1xyXG5cdFx0dmFyIHF1ZXJ5ID0gb2JqZWN0UHJveHkub2JzZXJ2ZSgpO1xyXG5cdFx0VmlkZW9BcHAuYXNzZXJ0KHF1ZXJ5ICE9IG51bGwsIFwiRXJyb3IgU3RhcnRpbmcgT2JzZXJ2YXRpb24gPSBcIiArIGNsYXNzVHlwZSwgbmV3IEVycm9yKCkpO1xyXG5cdFx0dGhpcy5oYW5kbGVBcnJheVs8c3RyaW5nPmNsYXNzVHlwZV0gPVxyXG5cdFx0XHRxdWVyeS5vYnNlcnZlQ2hhbmdlcyh7XHJcblx0XHRcdFx0YWRkZWQgIDogZnVuY3Rpb24gKGlkLCBmaWVsZHMpIHtcclxuXHRcdFx0XHRcdFx0XHR2YXIgdGhlT2JqZWN0ID0gRmFjdG9yeS5DcmVhdGVQcm94eUluc3RhbmNlKGNsYXNzVHlwZSkuZ2V0T25lKGlkKTtcclxuXHRcdFx0XHQgICAgICAgICAgICBPYmplY3RVcGRhdGVSb3V0ZXIuU2VuZEFkZE9iamVjdCh0aGVPYmplY3QpO1xyXG5cdFx0XHQgICAgICAgICAgICAgICAgfSxcclxuXHRcdFx0ICAgIGNoYW5nZWQgOiBmdW5jdGlvbiAoaWQsIGZpZWxkcykge1xyXG5cdFx0XHRcdCAgICAgICAgICAgIHZhciBvYmplY3QgPSBGYWN0b3J5LkNyZWF0ZVByb3h5SW5zdGFuY2UoY2xhc3NUeXBlKS5nZXRPbmUoaWQpO1xyXG5cdFx0XHRcdCAgICAgICAgICAgIE9iamVjdFVwZGF0ZVJvdXRlci5TZW5kT2JqZWN0Q2hhbmdlKG9iamVjdCk7XHJcblx0XHRcdCAgICAgICAgICAgICAgICB9LFxyXG5cdFx0XHQgICAgcmVtb3ZlZCA6IGZ1bmN0aW9uIChpZCkge1xyXG5cdFx0XHRcdCAgICAgICAgICAgIFVJLkluZm8oXCJSZW1vdmUgLS0tXCIrY2xhc3NUeXBlKTtcclxuXHRcdFx0XHQgICAgICAgICAgICBPYmplY3RVcGRhdGVSb3V0ZXIuU2VuZFJlbW92ZU9iamVjdChpZCwgY2xhc3NUeXBlKSB9XHJcblx0XHQgICAgICAgICAgICAgICAgICAgIH0pXHJcblx0fVxyXG5cdHB1YmxpYyBzdG9wT2JzZXJ2ZSgpIHtcclxuXHRcdGlmICghT2JqZWN0VXBkYXRlUm91dGVyLl9vYnNlcnZpbmcpIHJldHVybjtcclxuXHRcdE9iamVjdFVwZGF0ZVJvdXRlci5vYnNlcnZlUm91dGVyQ291bnQtLTtcclxuXHRcdGZvciAodmFyIG9ic2VydmF0aW9ucyBpbiB0aGlzLmhhbmRsZUFycmF5KSB7XHJcblx0XHRcdHRoaXMuaGFuZGxlQXJyYXlbb2JzZXJ2YXRpb25zXS5zdG9wKCk7XHJcblx0XHR9XHJcblx0XHRPYmplY3RVcGRhdGVSb3V0ZXIuX29ic2VydmluZyA9IGZhbHNlO1xyXG5cdH1cclxuXHRkZXN0cnVjdG9yKCkge1xyXG5cdFx0aWYgKCFPYmplY3RVcGRhdGVSb3V0ZXIuX29ic2VydmluZykgcmV0dXJuO1xyXG5cdFx0dGhpcy5zdG9wT2JzZXJ2ZSgpO1xyXG5cdH1cclxufVxyXG50aGlzLk9iamVjdFVwZGF0ZVJvdXRlciA9IE9iamVjdFVwZGF0ZVJvdXRlcjtcclxuIl19